classdef TestAsTable < matlab.unittest.TestCase
%TESTASTABLE  Tests for as_table parameter in load() and for_each().

    properties
        test_dir
    end

    methods (TestClassSetup)
        function addPaths(~)
            this_dir = fileparts(mfilename('fullpath'));
            run(fullfile(this_dir, 'setup_paths.m'));
        end
    end

    methods (TestMethodSetup)
        function setupDatabase(testCase)
            testCase.test_dir = tempname;
            mkdir(testCase.test_dir);
            scidb.configure_database( ...
                fullfile(testCase.test_dir, 'test.duckdb'), ...
                ["subject", "session"], ...
                fullfile(testCase.test_dir, 'pipeline.db'));
        end
    end

    methods (TestMethodTeardown)
        function cleanup(testCase)
            try
                scidb.get_database().close();
            catch
            end
            if isfolder(testCase.test_dir)
                rmdir(testCase.test_dir, 's');
            end
        end
    end

    methods (Test)

        function test_version_id_populated_after_load(testCase)
            %% version_id and parameter_id should be set after load
            ScalarVar().save(42, 'subject', 1, 'session', 'A');
            loaded = ScalarVar().load('subject', 1, 'session', 'A');
            testCase.verifyEqual(loaded.version_id, int64(1));
            testCase.verifyEqual(loaded.parameter_id, int64(1));
        end

        function test_load_as_table_multi_result(testCase)
            %% load(as_table=true) with multiple matches returns a table
            RawSignal().save([1 2 3], 'subject', 1, 'session', 'A');
            RawSignal().save([4 5 6], 'subject', 1, 'session', 'B');

            tbl = RawSignal().load('as_table', true, 'subject', 1);
            testCase.verifyTrue(istable(tbl));
            testCase.verifyEqual(height(tbl), 2);
            testCase.verifyTrue(ismember('subject', tbl.Properties.VariableNames));
            testCase.verifyTrue(ismember('session', tbl.Properties.VariableNames));
            testCase.verifyTrue(ismember('version_id', tbl.Properties.VariableNames));
            testCase.verifyTrue(ismember('RawSignal', tbl.Properties.VariableNames));
        end

        function test_load_as_table_single_result(testCase)
            %% load(as_table=true) with single match returns ThunkOutput, not table
            ScalarVar().save(42, 'subject', 1, 'session', 'A');
            result = ScalarVar().load('as_table', true, 'subject', 1, 'session', 'A');
            testCase.verifyTrue(isa(result, 'scidb.ThunkOutput'));
            testCase.verifyEqual(result.data, 42);
        end

        function test_load_as_table_false_returns_array(testCase)
            %% load(as_table=false) with multiple matches returns ThunkOutput array
            RawSignal().save([1 2 3], 'subject', 1, 'session', 'A');
            RawSignal().save([4 5 6], 'subject', 1, 'session', 'B');

            result = RawSignal().load('as_table', false, 'subject', 1);
            testCase.verifyTrue(isa(result, 'scidb.ThunkOutput'));
            testCase.verifyEqual(numel(result), 2);
        end

        function test_load_as_table_true_multiple_versions

        function test_for_each_as_table(testCase)
            %% for_each with as_table converts multi-result to table
            %  Save per-session data, iterate per subject
            RawSignal().save([1 2], 'subject', 1, 'session', 'A');
            RawSignal().save([3 4], 'subject', 1, 'session', 'B');

            received_table = [];

            function result = table_consumer(values)
                received_table = values;
                result = sum(cellfun(@(x) sum(x), values.RawSignal));
            end

            scidb.for_each(@table_consumer, ...
                struct('values', RawSignal()), ...
                {ScalarVar()}, ...
                'as_table', ["values"], ...
                'subject', 1);

            testCase.verifyTrue(istable(received_table));
            testCase.verifyEqual(height(received_table), 2);
        end

    end
end

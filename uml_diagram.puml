@startuml SciDB Framework

skinparam classAttributeIconSize 0
skinparam classFontSize 12
skinparam defaultFontSize 11
skinparam packageFontSize 14

title SciDB - Scientific Database Framework\nUML Class Diagram

package "scidb (Core Layer)" {

    abstract class BaseVariable <<abstract>> {
        +data: Any
        +schema_version: int
        -_vhash: str | None
        -_metadata: dict | None
        -_content_hash: str | None
        -_lineage_hash: str | None
        -_reserved_keys: frozenset
        -_all_subclasses: dict[str, type]
        __
        +{abstract} to_db(): pd.DataFrame
        +{abstract} from_db(df: pd.DataFrame): Any
        +save(db: DatabaseManager, **metadata): str
        +load(db: DatabaseManager, version: str, **metadata): BaseVariable
        +table_name(): str
        +save_from_dataframe(df, data_column, metadata_columns): list[str]
        +load_to_dataframe(db, include_vhash, **metadata): pd.DataFrame
        +to_csv(path: str): None
        +get_preview(): str
        +__init_subclass__()
        +get_subclass_by_name(name: str): type | None
    }

    class DatabaseManager {
        +db_path: Path
        +lineage_mode: str
        +connection: sqlite3.Connection
        -_registered_types: dict[str, Type[BaseVariable]]
        __
        +register(variable_class: Type[BaseVariable]): None
        +save(variable: BaseVariable, metadata: dict, lineage: LineageRecord): str
        +load(variable_class: Type, metadata: dict, version: str): BaseVariable
        +list_versions(variable_class, **metadata): list[dict]
        +get_provenance(variable_class, version, **metadata): dict
        +get_derived_from(variable_class, version, **metadata): list[dict]
        +get_full_lineage(variable_class, version, max_depth): dict
        +format_lineage(variable_class, version, **metadata): str
        +cache_computation(cache_key, function_name, ...): None
        +get_cached_computation(cache_key, variable_class): BaseVariable
        +get_cached_by_key(cache_key): list[tuple]
        +invalidate_cache(function_name, function_hash): int
        +get_cache_stats(): dict
        +export_to_csv(variable_class, path, **metadata): int
        +preview_data(variable_class, **metadata): str
        -_ensure_meta_tables(): None
        -_ensure_registered(variable_class): str
        -_row_to_variable(variable_class, row): BaseVariable
        -_save_lineage(output_vhash, output_type, lineage, ...): None
        +save_ephemeral_lineage(ephemeral_id, variable_type, ...): None
        -_build_lineage_tree(vhash, type_name, max_depth): dict
    }

    class SciDBError <<exception>> {
    }

    class NotRegisteredError <<exception>> {
    }

    class NotFoundError <<exception>> {
    }

    class DatabaseNotConfiguredError <<exception>> {
    }

    class ReservedMetadataKeyError <<exception>> {
    }

    class UnsavedIntermediateError <<exception>> {
    }
}

package "thunk (Lazy Evaluation Layer)" {

    class Thunk {
        +fcn: Callable
        +unpack_output: bool
        +unwrap: bool
        +hash: str
        +pipeline_thunks: tuple[PipelineThunk, ...]
        __
        +__init__(fcn, unpack_output, unwrap)
        +__call__(*args, **kwargs): ThunkOutput | tuple
        +__eq__(other): bool
        +__hash__(): int
    }

    class PipelineThunk {
        +thunk: Thunk
        +inputs: dict[str, Any]
        +outputs: tuple[ThunkOutput, ...]
        +unwrap: bool
        __
        +__init__(thunk, *args, **kwargs)
        +__call__(*args, **kwargs): ThunkOutput | tuple
        +hash: str <<property>>
        +compute_cache_key(): str
        +is_complete: bool <<property>>
        -{static} _is_trackable_variable(obj): bool
        -_deep_unwrap(value): Any
        -_matches(other): bool
    }

    class ThunkOutput {
        +pipeline_thunk: PipelineThunk
        +output_num: int
        +is_complete: bool
        +data: Any
        +hash: str
        -_was_cached: bool
        -_cached_id: str | None
        __
        +__init__(pipeline_thunk, output_num, is_complete, ...)
        +was_cached: bool <<property>>
        +cached_id: str <<property>>
        +__repr__(): str
        +__str__(): str
    }

    class LineageRecord {
        +function_name: str
        +function_hash: str
        +inputs: list[dict]
        +constants: list[dict]
        __
        +to_dict(): dict
        +{static} from_dict(data: dict): LineageRecord
    }

    interface CacheBackend <<protocol>> {
        +get_cached(cache_key: str): list[tuple] | None
    }
}

package "Utilities" {
    class "storage" <<module>> {
        +serialize_dataframe(df): bytes
        +deserialize_dataframe(blob): pd.DataFrame
        +register_adapters(): None
    }

    class "hashing" <<module>> {
        +generate_vhash(class_name, schema_version, ...): str
    }

    class "preview" <<module>> {
        +generate_preview(df: pd.DataFrame, max_length): str
    }
}

' ===== RELATIONSHIPS =====

' Inheritance
SciDBError <|-- NotRegisteredError
SciDBError <|-- NotFoundError
SciDBError <|-- DatabaseNotConfiguredError
SciDBError <|-- ReservedMetadataKeyError
SciDBError <|-- UnsavedIntermediateError

' Associations
DatabaseManager "1" -- "*" BaseVariable : manages >
DatabaseManager "1" -- "*" LineageRecord : stores >
DatabaseManager ..|> CacheBackend : implements

' Thunk system relationships
Thunk "1" *-- "*" PipelineThunk : creates >
PipelineThunk "1" *-- "1..*" ThunkOutput : produces >
ThunkOutput "*" --> "1" PipelineThunk : references >

' Cross-layer relationships
BaseVariable "1" o-- "0..1" ThunkOutput : wraps >
BaseVariable ..> LineageRecord : extracts from ThunkOutput >
BaseVariable ..> DatabaseManager : uses for persistence >

' Utility dependencies
DatabaseManager ..> "storage" : uses
DatabaseManager ..> "hashing" : uses
BaseVariable ..> "preview" : uses

legend right
  |= Symbol |= Meaning |
  | <|-- | Inheritance |
  | *-- | Composition |
  | o-- | Aggregation |
  | --> | Association |
  | ..> | Dependency |
  | ..|> | Implements |
endlegend

note bottom of BaseVariable
  User-defined variable types
  inherit from BaseVariable
  (e.g., ScalarValue, ArrayValue, MatrixValue)
end note

note bottom of Thunk
  @thunk decorator wraps
  functions for lineage tracking
end note

note right of DatabaseManager
  Internal SQLite tables:
  - _registered_types
  - _version_log
  - _data (content-addressed)
  - _lineage
  - _computation_cache
end note

@enduml
